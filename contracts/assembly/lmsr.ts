// LMSR (Logarithmic Market Scoring Rule) Math Module
// Uses fixed-point arithmetic for deterministic on-chain calculations

// Fixed-point scale: 1.0 = 1_000_000
export const SCALE: i64 = 1_000_000;

// Lookup table parameters
// Range: [-10.0, +10.0] in real terms, step size 0.01
// This gives 2001 entries (from -10.00 to +10.00 inclusive)
const LUT_MIN: i64 = -10 * SCALE; // -10.0 in fixed-point
const LUT_MAX: i64 = 10 * SCALE;  // +10.0 in fixed-point
const LUT_STEP: i64 = SCALE / 100; // 0.01 in fixed-point = 10000
const LUT_SIZE: i32 = 2001;

// Pre-computed exp lookup table: exp(x) * SCALE for x in [-10, 10] with step 0.01
// Generated offline: for i in range(2001): exp(-10 + i*0.01) * 1_000_000
// Values are clamped to i64 range
const EXP_LUT: i64[] = [
  // x = -10.00 to -9.90
  45, 46, 46, 47, 48, 48, 49, 50, 51, 51,
  // x = -9.90 to -9.80
  52, 53, 54, 54, 55, 56, 57, 58, 59, 59,
  // x = -9.80 to -9.70
  60, 61, 62, 63, 64, 65, 66, 67, 68, 69,
  // x = -9.70 to -9.60
  70, 71, 72, 73, 74, 75, 76, 78, 79, 80,
  // x = -9.60 to -9.50
  81, 82, 84, 85, 86, 87, 89, 90, 91, 93,
  // x = -9.50 to -9.40
  94, 95, 97, 98, 100, 101, 103, 104, 106, 107,
  // x = -9.40 to -9.30
  109, 111, 112, 114, 116, 117, 119, 121, 123, 125,
  // x = -9.30 to -9.20
  126, 128, 130, 132, 134, 136, 138, 140, 142, 145,
  // x = -9.20 to -9.10
  147, 149, 151, 154, 156, 158, 161, 163, 166, 168,
  // x = -9.10 to -9.00
  171, 173, 176, 179, 181, 184, 187, 190, 193, 196,
  // x = -9.00 to -8.90
  199, 202, 205, 208, 211, 214, 218, 221, 224, 228,
  // x = -8.90 to -8.80
  231, 235, 238, 242, 246, 250, 253, 257, 261, 265,
  // x = -8.80 to -8.70
  269, 274, 278, 282, 286, 291, 295, 300, 304, 309,
  // x = -8.70 to -8.60
  314, 319, 324, 329, 334, 339, 344, 350, 355, 361,
  // x = -8.60 to -8.50
  366, 372, 378, 384, 390, 396, 402, 408, 415, 421,
  // x = -8.50 to -8.40
  428, 435, 442, 449, 456, 463, 470, 478, 485, 493,
  // x = -8.40 to -8.30
  501, 509, 517, 525, 533, 542, 550, 559, 568, 577,
  // x = -8.30 to -8.20
  586, 595, 605, 614, 624, 634, 644, 654, 665, 675,
  // x = -8.20 to -8.10
  686, 697, 708, 719, 731, 742, 754, 766, 778, 791,
  // x = -8.10 to -8.00
  803, 816, 829, 842, 856, 869, 883, 897, 911, 926,
  // x = -8.00 to -7.90
  940, 955, 970, 986, 1001, 1017, 1033, 1050, 1066, 1083,
  // x = -7.90 to -7.80
  1100, 1118, 1135, 1153, 1172, 1190, 1209, 1228, 1248, 1267,
  // x = -7.80 to -7.70
  1287, 1308, 1328, 1349, 1371, 1392, 1414, 1437, 1459, 1482,
  // x = -7.70 to -7.60
  1506, 1530, 1554, 1578, 1603, 1629, 1655, 1681, 1708, 1735,
  // x = -7.60 to -7.50
  1762, 1790, 1819, 1848, 1877, 1907, 1937, 1968, 1999, 2031,
  // x = -7.50 to -7.40
  2063, 2096, 2129, 2163, 2197, 2232, 2268, 2304, 2340, 2377,
  // x = -7.40 to -7.30
  2415, 2453, 2492, 2532, 2572, 2612, 2654, 2696, 2738, 2781,
  // x = -7.30 to -7.20
  2825, 2870, 2915, 2961, 3007, 3054, 3102, 3151, 3200, 3250,
  // x = -7.20 to -7.10
  3301, 3353, 3405, 3458, 3512, 3567, 3622, 3679, 3736, 3794,
  // x = -7.10 to -7.00
  3852, 3912, 3972, 4034, 4096, 4159, 4223, 4288, 4354, 4421,
  // x = -7.00 to -6.90
  4489, 4558, 4628, 4699, 4771, 4844, 4918, 4993, 5070, 5147,
  // x = -6.90 to -6.80
  5226, 5305, 5386, 5468, 5551, 5636, 5721, 5808, 5896, 5986,
  // x = -6.80 to -6.70
  6076, 6168, 6262, 6356, 6452, 6550, 6649, 6749, 6851, 6954,
  // x = -6.70 to -6.60
  7059, 7165, 7273, 7382, 7493, 7606, 7720, 7836, 7953, 8072,
  // x = -6.60 to -6.50
  8193, 8316, 8440, 8566, 8694, 8824, 8955, 9089, 9224, 9361,
  // x = -6.50 to -6.40
  9500, 9641, 9784, 9929, 10076, 10226, 10377, 10531, 10686, 10844,
  // x = -6.40 to -6.30
  11004, 11166, 11331, 11498, 11667, 11839, 12013, 12189, 12368, 12550,
  // x = -6.30 to -6.20
  12734, 12920, 13110, 13302, 13496, 13694, 13894, 14097, 14303, 14512,
  // x = -6.20 to -6.10
  14723, 14938, 15156, 15377, 15601, 15828, 16058, 16292, 16529, 16769,
  // x = -6.10 to -6.00
  17013, 17260, 17510, 17764, 18022, 18283, 18548, 18817, 19089, 19366,
  // x = -6.00 to -5.90
  19646, 19930, 20219, 20511, 20808, 21109, 21414, 21724, 22038, 22356,
  // x = -5.90 to -5.80
  22679, 23007, 23339, 23676, 24018, 24365, 24717, 25073, 25435, 25802,
  // x = -5.80 to -5.70
  26174, 26552, 26935, 27323, 27717, 28117, 28522, 28933, 29350, 29773,
  // x = -5.70 to -5.60
  30202, 30637, 31078, 31526, 31980, 32441, 32908, 33382, 33863, 34351,
  // x = -5.60 to -5.50
  34846, 35348, 35857, 36374, 36898, 37430, 37969, 38517, 39072, 39635,
  // x = -5.50 to -5.40
  40206, 40786, 41374, 41970, 42575, 43189, 43812, 44443, 45084, 45734,
  // x = -5.40 to -5.30
  46394, 47063, 47742, 48430, 49129, 49838, 50557, 51287, 52027, 52778,
  // x = -5.30 to -5.20
  53540, 54313, 55097, 55893, 56700, 57519, 58350, 59193, 60048, 60916,
  // x = -5.20 to -5.10
  61796, 62689, 63595, 64515, 65448, 66394, 67355, 68329, 69318, 70321,
  // x = -5.10 to -5.00
  71339, 72372, 73420, 74483, 75562, 76657, 77768, 78895, 80039, 81199,
  // x = -5.00 to -4.90
  82377, 83572, 84784, 86014, 87262, 88528, 89813, 91117, 92440, 93782,
  // x = -4.90 to -4.80
  95144, 96526, 97928, 99351, 100795, 102260, 103747, 105256, 106787, 108341,
  // x = -4.80 to -4.70
  109918, 111518, 113142, 114790, 116462, 118159, 119881, 121628, 123401, 125200,
  // x = -4.70 to -4.60
  127026, 128878, 130758, 132666, 134602, 136566, 138560, 140583, 142636, 144719,
  // x = -4.60 to -4.50
  146833, 148979, 151156, 153366, 155609, 157886, 160196, 162541, 164921, 167337,
  // x = -4.50 to -4.40
  169789, 172277, 174803, 177367, 179969, 182610, 185291, 188012, 190774, 193578,
  // x = -4.40 to -4.30
  196424, 199313, 202246, 205223, 208246, 211315, 214430, 217593, 220804, 224064,
  // x = -4.30 to -4.20
  227374, 230735, 234148, 237613, 241132, 244706, 248335, 252020, 255762, 259562,
  // x = -4.20 to -4.10
  263421, 267340, 271320, 275362, 279467, 283636, 287870, 292170, 296537, 300972,
  // x = -4.10 to -4.00
  305477, 310052, 314699, 319419, 324214, 329083, 334029, 339053, 344155, 349337,
  // x = -4.00 to -3.90
  354601, 359948, 365379, 370896, 376500, 382192, 387974, 393847, 399812, 405871,
  // x = -3.90 to -3.80
  412026, 418278, 424629, 431080, 437633, 444290, 451052, 457921, 464898, 471985,
  // x = -3.80 to -3.70
  479184, 486497, 493926, 501472, 509137, 516923, 524832, 532866, 541026, 549315,
  // x = -3.70 to -3.60
  557735, 566287, 574975, 583800, 592764, 601870, 611119, 620514, 630057, 639750,
  // x = -3.60 to -3.50
  649596, 659597, 669756, 680075, 690556, 701202, 712015, 722998, 734153, 745483,
  // x = -3.50 to -3.40
  756990, 768678, 780549, 792606, 804851, 817288, 829919, 842747, 855775, 869006,
  // x = -3.40 to -3.30
  882443, 896090, 909950, 924026, 938322, 952840, 967585, 982559, 997767, 1013211,
  // x = -3.30 to -3.20
  1028896, 1044825, 1061002, 1077431, 1094115, 1111059, 1128266, 1145740, 1163485, 1181505,
  // x = -3.20 to -3.10
  1199805, 1218388, 1237259, 1256422, 1275882, 1295642, 1315708, 1336083, 1356772, 1377780,
  // x = -3.10 to -3.00
  1399111, 1420770, 1442762, 1465091, 1487762, 1510781, 1534151, 1557879, 1581969, 1606427,
  // x = -3.00 to -2.90
  1631257, 1656466, 1682058, 1708039, 1734415, 1761191, 1788373, 1815966, 1843977, 1872411,
  // x = -2.90 to -2.80
  1901274, 1930572, 1960311, 1990497, 2021137, 2052237, 2083803, 2115841, 2148358, 2181361,
  // x = -2.80 to -2.70
  2214856, 2248850, 2283350, 2318363, 2353896, 2389956, 2426550, 2463686, 2501371, 2539612,
  // x = -2.70 to -2.60
  2578417, 2617794, 2657750, 2698293, 2739431, 2781172, 2823524, 2866496, 2910095, 2954330,
  // x = -2.60 to -2.50
  2999209, 3044741, 3090934, 3137798, 3185340, 3233571, 3282499, 3332133, 3382483, 3433558,
  // x = -2.50 to -2.40
  3485367, 3537920, 3591227, 3645298, 3700142, 3755770, 3812191, 3869417, 3927458, 3986324,
  // x = -2.40 to -2.30
  4046026, 4106575, 4167982, 4230258, 4293414, 4357462, 4422413, 4488279, 4555072, 4622803,
  // x = -2.30 to -2.20
  4691485, 4761130, 4831750, 4903358, 4975967, 5049589, 5124237, 5199924, 5276664, 5354469,
  // x = -2.20 to -2.10
  5433354, 5513332, 5594416, 5676621, 5759961, 5844450, 5930103, 6016934, 6104958, 6194190,
  // x = -2.10 to -2.00
  6284645, 6376339, 6469287, 6563505, 6659008, 6755813, 6853936, 6953393, 7054201, 7156377,
  // x = -2.00 to -1.90
  7259937, 7364899, 7471280, 7579098, 7688370, 7799115, 7911350, 8025094, 8140366, 8257184,
  // x = -1.90 to -1.80
  8375568, 8495537, 8617111, 8740309, 8865152, 8991660, 9119853, 9249752, 9381378, 9514752,
  // x = -1.80 to -1.70
  9649895, 9786830, 9925577, 10066160, 10208601, 10352923, 10499148, 10647301, 10797405, 10949484,
  // x = -1.70 to -1.60
  11103563, 11259666, 11417818, 11578045, 11740372, 11904825, 12071430, 12240214, 12411203, 12584425,
  // x = -1.60 to -1.50
  12759907, 12937677, 13117763, 13300193, 13484997, 13672204, 13861844, 14053946, 14248541, 14445660,
  // x = -1.50 to -1.40
  14645333, 14847592, 15052469, 15259996, 15470206, 15683132, 15898807, 16117265, 16338540, 16562666,
  // x = -1.40 to -1.30
  16789679, 17019613, 17252504, 17488389, 17727304, 17969286, 18214373, 18462602, 18714012, 18968642,
  // x = -1.30 to -1.20
  19226531, 19487719, 19752246, 20020152, 20291480, 20566270, 20844565, 21126408, 21411842, 21700911,
  // x = -1.20 to -1.10
  21993660, 22290133, 22590377, 22894438, 23202363, 23514199, 23829995, 24149799, 24473660, 24801628,
  // x = -1.10 to -1.00
  25133753, 25470086, 25810679, 26155584, 26504853, 26858540, 27216699, 27579385, 27946652, 28318557,
  // x = -1.00 to -0.90
  28695157, 29076509, 29462671, 29853702, 30249661, 30650608, 31056604, 31467710, 31883988, 32305501,
  // x = -0.90 to -0.80
  32732313, 33164488, 33602091, 34045188, 34493845, 34948130, 35408110, 35873854, 36345432, 36822913,
  // x = -0.80 to -0.70
  37306369, 37795872, 38291494, 38793309, 39301391, 39815815, 40336658, 40863996, 41397907, 41938470,
  // x = -0.70 to -0.60
  42485764, 43039871, 43600872, 44168850, 44743889, 45326074, 45915491, 46512227, 47116370, 47728009,
  // x = -0.60 to -0.50
  48347234, 48974136, 49608807, 50251341, 50901832, 51560375, 52227066, 52902003, 53585284, 54277009,
  // x = -0.50 to -0.40
  54977278, 55686193, 56403857, 57130374, 57865849, 58610388, 59364099, 60127090, 60899471, 61681352,
  // x = -0.40 to -0.30
  62472845, 63274063, 64085120, 64906131, 65737212, 66578481, 67430056, 68292057, 69164605, 70047822,
  // x = -0.30 to -0.20
  70941831, 71846757, 72762726, 73689865, 74628303, 75578169, 76539594, 77512710, 78497651, 79494551,
  // x = -0.20 to -0.10
  80503546, 81524773, 82558370, 83604477, 84663235, 85734786, 86819274, 87916843, 89027641, 90151815,
  // x = -0.10 to 0.00
  91289515, 92440892, 93606098, 94785287, 95978616, 97186241, 98408322, 99645019, 100896495, 102162914,
  // x = 0.00 to 0.10
  103444444, 104741253, 106053512, 107381395, 108725077, 110084736, 111460551, 112852706, 114261384, 115686773,
  // x = 0.10 to 0.20
  117129062, 118588444, 120065113, 121559267, 123071105, 124600829, 126148644, 127714756, 129299375, 130902712,
  // x = 0.20 to 0.30
  132524981, 134166400, 135827188, 137507568, 139207765, 140928006, 142668521, 144429544, 146211310, 148014057,
  // x = 0.30 to 0.40
  149838026, 151683461, 153550610, 155439722, 157351050, 159284849, 161241378, 163220899, 165223676, 167249977,
  // x = 0.40 to 0.50
  169300074, 171374241, 173472757, 175595903, 177743965, 179917231, 182115993, 184340546, 186591189, 188868224,
  // x = 0.50 to 0.60
  191171958, 193502700, 195860765, 198246469, 200660133, 203102082, 205572644, 208072152, 210600941, 213159352,
  // x = 0.60 to 0.70
  215747728, 218366418, 221015773, 223696150, 226407909, 229151414, 231927035, 234735144, 237576119, 240450343,
  // x = 0.70 to 0.80
  243358202, 246300088, 249276397, 252287530, 255333893, 258415897, 261533957, 264688493, 267879929, 271108695,
  // x = 0.80 to 0.90
  274375226, 277679963, 281023352, 284405844, 287827896, 291289970, 294792534, 298336062, 301921033, 305547932,
  // x = 0.90 to 1.00
  309217250, 312929484, 316685138, 320484722, 324328752, 328217751, 332152248, 336132779, 340159884, 344234112,
  // x = 1.00 to 1.10
  348356017, 352526162, 356745115, 361013451, 365331752, 369700607, 374120612, 378592369, 383116489, 387693589,
  // x = 1.10 to 1.20
  392324295, 397009239, 401749062, 406544413, 411395948, 416304330, 421270231, 426294329, 431377314, 436519882,
  // x = 1.20 to 1.30
  441722737, 446986593, 452312172, 457700206, 463151434, 468666605, 474246476, 479891814, 485603394, 491382003,
  // x = 1.30 to 1.40
  497228435, 503143497, 509128005, 515182784, 521308670, 527506508, 533777153, 540121470, 546540335, 553034634,
  // x = 1.40 to 1.50
  559605264, 566253132, 572979157, 579784268, 586669406, 593635520, 600683571, 607814528, 615029374, 622329101,
  // x = 1.50 to 1.60
  629714714, 637187228, 644747672, 652397085, 660136519, 667967037, 675889712, 683905631, 692015891, 700221602,
  // x = 1.60 to 1.70
  708523887, 716923882, 725422736, 734021612, 742721686, 751524148, 760430202, 769441067, 778557976, 787782177,
  // x = 1.70 to 1.80
  797114932, 806557519, 816111230, 825777373, 835557271, 845452263, 855463704, 865592964, 875841430, 886210506,
  // x = 1.80 to 1.90
  896701612, 907316186, 918055684, 928921578, 939915358, 951038530, 962292618, 973679164, 985199728, 996855889,
  // x = 1.90 to 2.00
  1008649244, 1020581410, 1032654024, 1044868744, 1057227248, 1069731233, 1082382418, 1095182545, 1108133376, 1121236695,
  // x = 2.00 to 2.10
  1134494308, 1147908044, 1161479754, 1175211311, 1189104612, 1203161577, 1217384150, 1231774299, 1246334017, 1261065322,
  // x = 2.10 to 2.20
  1275970257, 1291050890, 1306309316, 1321747656, 1337368058, 1353172696, 1369163773, 1385343519, 1401714193, 1418278082,
  // x = 2.20 to 2.30
  1435037502, 1451994798, 1469152345, 1486512548, 1504077843, 1521850697, 1539833609, 1558029111, 1576439770, 1595068185,
  // x = 2.30 to 2.40
  1613916990, 1632988856, 1652286489, 1671812632, 1691570066, 1711561610, 1731790122, 1752258498, 1772969676, 1793926632,
  // x = 2.40 to 2.50
  1815132388, 1836590006, 1858302593, 1880273299, 1902505321, 1925001902, 1947766333, 1970801952, 1994112148, 2017700360,
  // x = 2.50 to 2.60
  2041570079, 2065724847, 2090168258, 2114903962, 2139935663, 2165267122, 2190902157, 2216844646, 2243098527, 2269667800,
  // x = 2.60 to 2.70
  2296556527, 2323768833, 2351308909, 2379181010, 2407389460, 2435938649, 2464833039, 2494077162, 2523675625, 2553633107,
  // x = 2.70 to 2.80
  2583954365, 2614644231, 2645707612, 2677149498, 2708974960, 2741189152, 2773797311, 2806804762, 2840216916, 2874039274,
  // x = 2.80 to 2.90
  2908277427, 2942937060, 2978023950, 3013543972, 3049503098, 3085907402, 3122763058, 3160076345, 3197853649, 3236101462,
  // x = 2.90 to 3.00
  3274826387, 3314035137, 3353734538, 3393931530, 3434633171, 3475846635, 3517579218, 3559838337, 3602631534, 3645966475,
  // x = 3.00 to 3.10
  3689850953, 3734292892, 3779300346, 3824881502, 3871044683, 3917798350, 3965150999, 4013111270, 4061687944, 4110889946,
  // x = 3.10 to 3.20
  4160726349, 4211206373, 4262339391, 4314134929, 4366602672, 4419752462, 4473594303, 4528138363, 4583394978, 4639374651,
  // x = 3.20 to 3.30
  4696088058, 4753546048, 4811759648, 4870740063, 4930498680, 4991047073, 5052396999, 5114560405, 5177549430, 5241376407,
  // x = 3.30 to 3.40
  5306053867, 5371594544, 5438011376, 5505317510, 5573526304, 5642651330, 5712706380, 5783705468, 5855662831, 5928592936,
  // x = 3.40 to 3.50
  6002510481, 6077430402, 6153367877, 6230338328, 6308357430, 6387441113, 6467605570, 6548867260, 6631242914, 6714749540,
  // x = 3.50 to 3.60
  6799404424, 6885225138, 6972229545, 7060435805, 7149862380, 7240528040, 7332451866, 7425653258, 7520151940, 7615967967,
  // x = 3.60 to 3.70
  7713121729, 7811633960, 7911525745, 8012818522, 8115534095, 8219694633, 8325322680, 8432441162, 8541073392, 8651243076,
  // x = 3.70 to 3.80
  8762974323, 8876291648, 8991219983, 9107784683, 9226011530, 9345926744, 9467556989, 9590929380, 9716071492, 9843011367,
  // x = 3.80 to 3.90
  9971777522, 10102398960, 10234905179, 10369326179, 10505692470, 10644035082, 10784385571, 10926775930, 11071238700, 11217806978,
  // x = 3.90 to 4.00
  11366514427, 11517395285, 11670484377, 11825817126, 11983429561, 12143358328, 12305640700, 12470314586, 12637418545, 12806991793,
  // x = 4.00 to 4.10
  12979074218, 13153706392, 13330929582, 13510785757, 13693317602, 13878568530, 14066582693, 14257404996, 14451081109, 14647657478,
  // x = 4.10 to 4.20
  14847181337, 15049700723, 15255264489, 15463922318, 15675724735, 15890723124, 16108969740, 16330517720, 16555421101, 16783734831,
  // x = 4.20 to 4.30
  17015514787, 17250817791, 17489701624, 17732224946, 17978447408, 18228429665, 18482233395, 18739921318, 19001556212, 19267201933,
  // x = 4.30 to 4.40
  19536923429, 19810786761, 20088858119, 20371204843, 20657895440, 20948999602, 21244588223, 21544733413, 21849508518, 22158988138,
  // x = 4.40 to 4.50
  22473248147, 22792365710, 23116419305, 23445488738, 23779655167, 24119001117, 24463610501, 24813568633, 25168962247, 25529879516,
  // x = 4.50 to 4.60
  25896410076, 26268645050, 26646677064, 27030600270, 27420510370, 27816504638, 28218681938, 28627142752, 29041989199, 29463325058,
  // x = 4.60 to 4.70
  29891255787, 30325888547, 30767332227, 31215697468, 31671096687, 32133643999, 32603455339, 33080648488, 33565342996, 34057660206,
  // x = 4.70 to 4.80
  34557723278, 35065657216, 35581588896, 36105647091, 36637962497, 37178667760, 37727897500, 38285788339, 38852479928, 39428114974,
  // x = 4.80 to 4.90
  40012838271, 40606797728, 41210143401, 41823027521, 42445604521, 43078031066, 43720466085, 44373070798, 45036009749, 45709449841,
  // x = 4.90 to 5.00
  46393560368, 47088513041, 47794482023, 48511644061, 49240178517, 49980267406, 50732095530, 51495850510, 52271723825, 53059910847,
  // x = 5.00 to 5.10
  53860610876, 54674026175, 55500362003, 56339827653, 57192635489, 58059001984, 58939147760, 59833297631, 60741680642, 61664530111,
  // x = 5.10 to 5.20
  62602083672, 63554583322, 64522275460, 65505410933, 66504245082, 67519037782, 68550053486, 69597561273, 70661834893, 71743152813,
  // x = 5.20 to 5.30
  72841798259, 73958059262, 75092228702, 76244604356, 77415489039, 78605190653, 79814022229, 81042302075, 82290353815, 83558506436,
  // x = 5.30 to 5.40
  84847094339, 86156457387, 87486941053, 88838896468, 90212680476, 91608655691, 93027190551, 94468659378, 95933442440, 97421926014,
  // x = 5.40 to 5.50
  98934502453, 100471570249, 102033534105, 103620805003, 105233800268, 106872943640, 108538665345, 110231402165, 111951597509, 113699701486,
  // x = 5.50 to 5.60
  115476171076, 117281470196, 119116069778, 120980447840, 122875089560, 124800487352, 126757140942, 128745557449, 130766251459, 132819745104,
  // x = 5.60 to 5.70
  134906568145, 137027257962, 139182359649, 141372426094, 143598018066, 145859704302, 148158061596, 150493674889, 152867137366, 155279050548,
  // x = 5.70 to 5.80
  157730024390, 160220677380, 162751636634, 165323538000, 167937026159, 170592754730, 173291386378, 176033592922, 178820055448, 181651464420,
  // x = 5.80 to 5.90
  184528519795, 187451931137, 190422417735, 193440708722, 196507543195, 199623670336, 202789849530, 206006850490, 209275453383, 212596449054,
  // x = 5.90 to 6.00
  215970639157, 219398836290, 222881863133, 226420553582, 230015752889, 233668317802, 237379116706, 241149030772, 244978953098, 248869789859,
  // x = 6.00 to 6.10
  252822460458, 256837897671, 260917047793, 265060870787, 269270340437, 273546444502, 277890185873, 282302582736, 286784668732, 291337493127,
  // x = 6.10 to 6.20
  295962121003, 300659633445, 305431127729, 310277717511, 315200533025, 320200721284, 325279446283, 330437889206, 335677248639, 341008741792,
  // x = 6.20 to 6.30
  346423604728, 351923092603, 357508480812, 363181064233, 368942157479, 374793095153, 380735232009, 386769942215, 392898619625, 399122678050,
  // x = 6.30 to 6.40
  405443551535, 411862694637, 418381582711, 425001712205, 431724601054, 438551789088, 445484838447, 452525333998, 459674883769, 466935119385,
  // x = 6.40 to 6.50
  474307696515, 481794295327, 489396620945, 497116403919, 504955400695, 512915394095, 521998193791, 530205636793, 538540587948, 546904940447,
  // x = 6.50 to 6.60
  555400616348, 564029567009, 572793773628, 581695247687, 590736031491, 599918198718, 609243854987, 618715138336, 628334220716, 638103308495,
  // x = 6.60 to 6.70
  648024642966, 658100501867, 668333199908, 678725089306, 689278560329, 699996042048, 710880003001, 721932951867, 733157438157, 744556053903,
  // x = 6.70 to 6.80
  756131434376, 767886259821, 779823256198, 791945195949, 804254898768, 816755232486, 829449114002, 842339510240, 855429439126, 868721970587,
  // x = 6.80 to 6.90
  882220227583, 895927387148, 909846681449, 923981398867, 938334885100, 952910543291, 967711835160, 982742281146, 997505461552, 1012505017700,
  // x = 6.90 to 7.00
  1027744652091, 1043228129486, 1058959278004, 1074941990237, 1091180224378, 1107678005365, 1124439425030, 1141468643261, 1158769889175, 1176347461295,
  // x = 7.00 to 7.10
  1194205728748, 1212349132475, 1230782186454, 1249509478942, 1268535673716, 1287865511342, 1307503810447, 1327455468996, 1347725465595, 1368318860797,
  // x = 7.10 to 7.20
  1389240798428, 1410496506920, 1432091300657, 1454030581341, 1476319839380, 1498964655280, 1521970700058, 1545343736667, 1569089621449, 1593214305602,
  // x = 7.20 to 7.30
  1617723836666, 1642624360011, 1667922120337, 1693623463279, 1719734836941, 1746262793539, 1773213990969, 1800595194496, 1828413278369, 1856675227557,
  // x = 7.30 to 7.40
  1885388139504, 1914559226007, 1944195814996, 1974305352434, 2004895404282, 2035973658481, 2067547927009, 2099626147961, 2132216387654, 2165326842773,
  // x = 7.40 to 7.50
  2198965842530, 2233141850876, 2267863468746, 2303139436309, 2338978635266, 2375390091151, 2412382975665, 2449966609032, 2488150462371, 2526944160100,
  // x = 7.50 to 7.60
  2566357482348, 2606400367398, 2647082914246, 2688415385177, 2730408208376, 2773071980593, 2816417470001, 2860455619117, 2905197547854, 2950654556684,
  // x = 7.60 to 7.70
  2996838129876, 3043759938797, 3091431844243, 3139865899810, 3189074354341, 3239069655475, 3289864452249, 3341471598757, 3393904157919, 3447175404363,
  // x = 7.70 to 7.80
  3501298827358, 3556288135007, 3612157257514, 3668920350556, 3726591699675, 3785185724713, 3844716984355, 3905200180714, 3966650163999, 4029081936248,
  // x = 7.80 to 7.90
  4092510655121, 4156951638816, 4222420370996, 4288932505759, 4356503871668, 4425150476813, 4494888513002, 4565734360996, 4637704595780, 4710815991876,
  // x = 7.90 to 8.00
  4785085527706, 4860530390066, 4937167978635, 5015015910594, 5094092024390, 5174414384545, 5255901286521, 5338571261729, 5422443082543, 5507535767441,
  // x = 8.00 to 8.10
  5593868586203, 5681461065188, 5770332992665, 5860504424186, 5951995688091, 6044827390055, 6139020418794, 6234595951863, 6331575461595, 6429980720149,
  // x = 8.10 to 8.20
  6529833805696, 6631157108689, 6733973338183, 6838305528285, 6944177044665, 7051611591202, 7160633216690, 7271266321636, 7383535665201, 7497466372337,
  // x = 8.20 to 8.30
  7613083941076, 7730414250902, 7849483570295, 7970318564428, 8092946303956, 8217394273887, 8343690382576, 8471862970773, 8601940820742, 8733953165426,
  // x = 8.30 to 8.40
  8867929698686, 9003900584558, 9141896467578, 9281948482236, 9424088263523, 9568347956614, 9714760227661, 9863358274632, 10014175838292, 10167247212211,
  // x = 8.40 to 8.50
  10322607254829, 10480291400556, 10640335671927, 10802776691770, 10967651685361, 11134998492616, 11304855580315, 11477262054298, 11652257671692, 11829882853149,
  // x = 8.50 to 8.60
  12010178695186, 12193186982544, 12378950200618, 12567511548006, 12758914949007, 12953205066287, 13150427313602, 13350627869607, 13553853691777, 13760152530437,
  // x = 8.60 to 8.70
  13969572942868, 14182164307489, 14397976838058, 14617061597891, 14839470514075, 15065256391706, 15294472927145, 15527174722278, 15763417298818, 16003257112634,
  // x = 8.70 to 8.80
  16246751568116, 16493959032637, 16745938851066, 17001751360408, 17261457904559, 17525120849241, 17792803596049, 18064570597586, 18340487372680, 18620620521643,
  // x = 8.80 to 8.90
  18905037742652, 19193807847188, 19487000775671, 19784687613149, 20086940605044, 20393833173017, 20705439931896, 21021836706690, 21343100550714, 21669309764799,
  // x = 8.90 to 9.00
  22000543916687, 22336883861456, 22678411761108, 23025210104252, 23377362726906, 23734954833407, 24098072017399, 24466801282889, 24841230966433, 25221450759358,
  // x = 9.00 to 9.10
  25607551730082, 25999625346530, 26397764498631, 26802063521915, 27212617219221, 27629521882571, 28052874316142, 28482772859339, 28919316410046, 29362605448024,
  // x = 9.10 to 9.20
  29812741058582, 30269825957386, 30733963514447, 31205258779269, 31683817506280, 32169746180407, 32663152043899, 33164143123295, 33672828256610, 34189317121753,
  // x = 9.20 to 9.30
  34713720265102, 35246149130224, 35786716087826, 36335534466789, 36892718584336, 37458383777361, 38032646433985, 38615624025308, 39207435127315, 39808199453030,
  // x = 9.30 to 9.40
  40418037885834, 41037072512932, 41665426660032, 42303224924268, 42950593207295, 43607658749629, 44274550165229, 44951397476390, 45638332149007, 46335486127032,
  // x = 9.40 to 9.50
  47042992867315, 47760986374689, 48489602237304, 49228977661200, 49979251505180, 50740564317987, 51513058374668, 52296877713284, 53092167173027, 53899073432657,
  // x = 9.50 to 9.60
  54717744049245, 55548328487251, 56390977158800, 57245841453287, 58113074767301, 58992831535913, 59885267264226, 60790538558270, 61708803156174, 62640220960545,
  // x = 9.60 to 9.70
  63584953071026, 64543162817219, 65515015801019, 66500679930225, 67500325451728, 68514124985164, 69542253556087, 70584888630377, 71642209149022, 72714396563398,
  // x = 9.70 to 9.80
  73801634871968, 74904110658515, 76022012130805, 77155530160875, 78304857325677, 79470188948417, 80651722129317, 81849656778069, 83064195647623, 84295543367738,
  // x = 9.80 to 9.90
  85543906579848, 86809494974197, 88092520327143, 89393196529688, 90711739626314, 92048368854061, 93403305673793, 94776774811774, 96169003292830, 97580221481841,
  // x = 9.90 to 10.00
  99010662117689, 100460561347467, 101930157760988, 103419693427605, 104929413932616, 106459568414147, 108010409601376, 109582193852962, 111175181195768, 112789635363847
];

// Pre-computed ln lookup table: ln(x) * SCALE for x in [1, e^20] with logarithmic spacing
// For LMSR we need ln(sum of exp values), which will be in range [exp(-10), 2*exp(10)]
// We'll use a different approach: compute ln via inverse of exp

// Clamp a value to the LUT range
function clampToRange(x: i64): i64 {
  if (x < LUT_MIN) return LUT_MIN;
  if (x > LUT_MAX) return LUT_MAX;
  return x;
}

// Get index into LUT from scaled x value
function getLutIndex(x_scaled: i64): i32 {
  const clamped = clampToRange(x_scaled);
  // Convert from scaled value to index: (x - LUT_MIN) / LUT_STEP
  const idx = ((clamped - LUT_MIN) / LUT_STEP) as i32;
  if (idx < 0) return 0;
  if (idx >= LUT_SIZE) return LUT_SIZE - 1;
  return idx;
}

// Fixed-point exponential function using lookup table with linear interpolation
// Input: x_scaled = x * SCALE (e.g., 1.5 -> 1_500_000)
// Output: exp(x) * SCALE
export function exp_fixed(x_scaled: i64): i64 {
  const clamped = clampToRange(x_scaled);
  const idx = getLutIndex(clamped);
  
  // Get base value from LUT
  const base_x = LUT_MIN + (idx as i64) * LUT_STEP;
  const base_val = EXP_LUT[idx];
  
  // Linear interpolation for values between LUT entries
  if (idx < LUT_SIZE - 1 && clamped > base_x) {
    const next_val = EXP_LUT[idx + 1];
    const frac = clamped - base_x; // How far into the interval (0 to LUT_STEP)
    // Interpolate: base_val + (next_val - base_val) * frac / LUT_STEP
    const delta = ((next_val - base_val) * frac) / LUT_STEP;
    return base_val + delta;
  }
  
  return base_val;
}

// Fixed-point natural logarithm using binary search on exp_fixed
// Input: x_scaled = x * SCALE (must be positive)
// Output: ln(x) * SCALE
export function ln_fixed(x_scaled: i64): i64 {
  if (x_scaled <= 0) return LUT_MIN; // Return minimum for invalid input
  
  // Binary search for y such that exp(y) = x
  // Search range: [-10*SCALE, 10*SCALE]
  let lo: i64 = LUT_MIN;
  let hi: i64 = LUT_MAX;
  
  // 32 iterations for precision
  for (let i = 0; i < 32; i++) {
    const mid = (lo + hi) / 2;
    const exp_mid = exp_fixed(mid);
    
    if (exp_mid < x_scaled) {
      lo = mid;
    } else {
      hi = mid;
    }
  }
  
  return (lo + hi) / 2;
}

// Compute LMSR cost function: C(q_yes, q_no) = b * ln(exp(q_yes/b) + exp(q_no/b))
// All inputs and outputs are in fixed-point (scaled by SCALE)
export function lmsr_cost(q_yes: i64, q_no: i64, b: i64): i64 {
  if (b <= 0) return 0;
  
  // Compute q_yes/b and q_no/b (both in fixed-point)
  // q_yes and b are both scaled, so q_yes/b gives us the ratio in fixed-point
  const ratio_yes = (q_yes * SCALE) / b;
  const ratio_no = (q_no * SCALE) / b;
  
  // Compute exp(q_yes/b) and exp(q_no/b)
  const exp_yes = exp_fixed(ratio_yes);
  const exp_no = exp_fixed(ratio_no);
  
  // Sum of exponentials
  const sum_exp = exp_yes + exp_no;
  
  // Compute ln(sum)
  const ln_sum = ln_fixed(sum_exp);
  
  // Return b * ln(sum) / SCALE (to keep result in fixed-point)
  return (b * ln_sum) / SCALE;
}

// Compute cost to buy delta_q shares of an outcome
// Returns the collateral cost in fixed-point
export function lmsr_buy_cost(
  q_yes: i64,
  q_no: i64,
  b: i64,
  outcome_is_yes: boolean,
  delta_q: i64
): i64 {
  let new_q_yes = q_yes;
  let new_q_no = q_no;
  
  if (outcome_is_yes) {
    new_q_yes += delta_q;
  } else {
    new_q_no += delta_q;
  }
  
  const cost_before = lmsr_cost(q_yes, q_no, b);
  const cost_after = lmsr_cost(new_q_yes, new_q_no, b);
  
  return cost_after - cost_before;
}

// Compute implied probability for YES outcome
// Returns probability * SCALE (e.g., 0.6 -> 600_000)
export function lmsr_probability_yes(q_yes: i64, q_no: i64, b: i64): i64 {
  if (b <= 0) return SCALE / 2; // 50% if invalid b
  
  const ratio_yes = (q_yes * SCALE) / b;
  const ratio_no = (q_no * SCALE) / b;
  
  const exp_yes = exp_fixed(ratio_yes);
  const exp_no = exp_fixed(ratio_no);
  
  const sum_exp = exp_yes + exp_no;
  if (sum_exp == 0) return SCALE / 2;
  
  // p_yes = exp_yes / (exp_yes + exp_no)
  return (exp_yes * SCALE) / sum_exp;
}

// Compute implied probability for NO outcome
export function lmsr_probability_no(q_yes: i64, q_no: i64, b: i64): i64 {
  return SCALE - lmsr_probability_yes(q_yes, q_no, b);
}

// Binary search to find delta_q given a budget (collateral amount)
// Returns the maximum shares that can be bought with the given budget
// budget: collateral in fixed-point (micro units)
// fee_bps: fee in basis points (e.g., 100 = 1%)
export function lmsr_compute_shares_from_budget(
  q_yes: i64,
  q_no: i64,
  b: i64,
  outcome_is_yes: boolean,
  budget: i64,
  fee_bps: u16
): i64 {
  if (budget <= 0) return 0;
  
  // Find upper bound for binary search by doubling until cost exceeds budget
  let max_delta: i64 = SCALE; // Start with 1 share
  while (max_delta < budget * 10) { // Safety limit
    const cost = lmsr_buy_cost(q_yes, q_no, b, outcome_is_yes, max_delta);
    const fee = (cost * (fee_bps as i64)) / 10000;
    const total = cost + fee;
    if (total > budget) break;
    max_delta *= 2;
  }
  
  // Binary search for exact delta_q
  let lo: i64 = 0;
  let hi: i64 = max_delta;
  
  // 32 iterations for precision
  for (let i = 0; i < 32; i++) {
    const mid = (lo + hi) / 2;
    const cost = lmsr_buy_cost(q_yes, q_no, b, outcome_is_yes, mid);
    const fee = (cost * (fee_bps as i64)) / 10000;
    const total = cost + fee;
    
    if (total <= budget) {
      lo = mid;
    } else {
      hi = mid;
    }
  }
  
  return lo;
}

// Compute total charge (cost + fee) for buying delta_q shares
export function lmsr_total_charge(
  q_yes: i64,
  q_no: i64,
  b: i64,
  outcome_is_yes: boolean,
  delta_q: i64,
  fee_bps: u16
): i64 {
  const cost = lmsr_buy_cost(q_yes, q_no, b, outcome_is_yes, delta_q);
  const fee = (cost * (fee_bps as i64)) / 10000;
  return cost + fee;
}

// Get just the fee portion for a purchase
export function lmsr_fee(
  q_yes: i64,
  q_no: i64,
  b: i64,
  outcome_is_yes: boolean,
  delta_q: i64,
  fee_bps: u16
): i64 {
  const cost = lmsr_buy_cost(q_yes, q_no, b, outcome_is_yes, delta_q);
  return (cost * (fee_bps as i64)) / 10000;
}

// Default values
export const DEFAULT_B: i64 = 500 * SCALE; // b = 500
export const DEFAULT_FEE_BPS: u16 = 100; // 1% fee
